---
title: "Project 2"
author: "Jeffrey Zhuohui Liang"
date: "3/24/2021"
output: pdf_document
---

```{r setup, include=FALSE}
library(MASS)
library(caret)
library(parallel)
library(foreach)
library(ggfortify)
library(cluster)
library(tidyverse)

knitr::opts_chunk$set(
  fig.height = 6,
  fig.width = 8,
  message = F,
  echo = T,
  warning = F,
  cache = F
)

theme_set(theme_minimal() + theme(legend.position = "bottom", 
                                  title = element_text(hjust = 0.5)))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis",
  digits = 3
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

set.seed(123123)
```

```{r load_data, echo=F}
sngcll_raw = 
  read_csv("ss.csv") 

sngcll = sngcll_raw %>% 
  janitor::clean_names()
```

```{r eval=F}
pc = prcomp(sngcll, scale = T, center = T)
eigs = pc$sdev^2
summary.table = rbind(
  SD = sqrt(eigs),
  Proportion = eigs/sum(eigs),
  Cumulative = cumsum(eigs)/sum(eigs))
summary.table[,1:10] %>% 
  knitr::kable()
scores = pc$x
```


# Method

## Data Preparation

```{r standardize_data}
# drop gene that 90% is zero 
drop_gene = 
  sngcll %>% 
  summarise(across(everything(),~sum(.x==0)/n()<0.9)) %>% 
  slice(1) %>% 
  unlist() %>% 
  as.vector()

sngcll_dp0 = 
  sngcll[,drop_gene]
```

```{r pca}
# PCA with scale
sngcll_pca =
  #predict(preProcess(sngcll_dp0,c("center","scale","pca")),sngcll_dp0)
  prcomp( ~ .,
          data = sngcll_dp0,
          tol = sqrt(.Machine$double.eps),
          center =F,
          scale. = F)

summary(sngcll_pca)$importance %>% 
  t() %>% 
  .[seq(1,230,8),] %>% 
  as_tibble(rownames = NA) %>% 
  knitr::kable(digits = 2)
```

Using 90% as threshold for Principle component selection, we see that up to `r sum(summary(sngcll_pca)$importance[3,]<.9)` can explain 90% of the standard deviation in data.

```{r EM_data}
# EM data preparation
sngcll_pca =
  predict(preProcess(
    sngcll_dp0,
    c("center", "scale", "pca","center","scale"),
    pcaComp = sum(summary(sngcll_pca)$importance[3, ]<.9)
  ), sngcll_dp0)
```


## Gaussian Mixture Model
```{r simulate_example echo = F}
mu1 = c(1,2,3)
sgm1 = diag(mu1)
mu2 = c(2,3,4)
sgm2 = diag(mu2)
mu3 = c(4,5,6)
sgm3 = diag(mu3)
mu = list(mu1,mu2,mu3)
sgm = list(sgm1,sgm2,sgm3)
cell = c(100,200,300)
sim_data = mclapply(X=1:3,
                    FUN = function(x){
                      MASS::mvrnorm(cell[[x]],
                                    mu[[x]],
                                    sgm[[x]])
                    },
                    mc.cores = 3) %>% 
  do.call(rbind,.)
```


```{r eval = F}
source("EM2.R")
EM_MG_algrm(sim_data,3)
set.seed(123)
rslt_1 = 
  mclapply(X = 2:10,
           FUN = 
             function(x)
               EM_MG_algrm(sngcll_pca,x)) %>% 
  do.call(rbind,.)

source("EM.R")
gaussian_mixture(sim_data,3)
set.seed(123123)
rslt_2 = lapply(11:2, FUN = function(x) gaussian_mixture(sngcll_pca,x)) %>% do.call(rbind,.)
save(rslt_2,file = "EM.Rdata")
```

